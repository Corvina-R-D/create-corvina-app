apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: {{ .Values.rabbitmq.clusterName }}
spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: {{ .Values.rabbitmq.clusterName }}
          topologyKey: kubernetes.io/hostname
        weight: 100
  {{- with .Values.rabbitmq.resources }}
  resources:
    {{ toYaml . | nindent 4 }}
  {{- end }}
  replicas: {{ .Values.rabbitmq.replicas }}
  image: {{ .Values.rabbitmq.image }}
  persistence:
    storageClassName: {{ .Values.rabbitmq.storageClass }}
    storage: {{ .Values.rabbitmq.storageSize }}
  rabbitmq:
    additionalConfig: |
      queue_leader_locator: balanced
      cluster_partition_handling: pause_minority
    additionalPlugins:
        - rabbitmq_management
        - rabbitmq_peer_discovery_k8s
        - rabbitmq_federation_management
        - rabbitmq_shovel
        - rabbitmq_shovel_management
        - rabbitmq_prometheus
        - rabbitmq_consistent_hash_exchange
        - rabbitmq_top
        - rabbitmq_delayed_message_exchange
        - rabbitmq_stream
  {{- if .Values.rabbitmq.fakeAuth }}
  secretBackend:
    externalSecret:
      name: "{{ .Values.rabbitmq.clusterName }}-default-user"
  {{- end }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ .Values.rabbitmq.clusterName }}
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Values.rabbitmq.clusterName }}
---
{{- if .Values.rabbitmq.fakeAuth }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.rabbitmq.clusterName }}-default-user
type: Opaque
stringData:
  type: rabbitmq
  provider: rabbitmq
  host: {{ .Values.rabbitmq.clusterName }}
  default_user.conf: |
    default_user = admin
    default_pass = password
  username: admin
  password: password
  port: "5672"
  stream-port: "5552"
{{- end }}
